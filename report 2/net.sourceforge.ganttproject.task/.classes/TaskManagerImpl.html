


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html id="htmlId">
<head>
  <title>Coverage Report :: TaskManagerImpl</title>
  <style type="text/css">
    @import "../../.css/coverage.css";
  </style>
</head>

<body>
<div class="header"></div>

<div class="content">
<div class="breadCrumbs">
    [ <a href="../../index.html">all classes</a> ]
    [ <a href="../index.html">net.sourceforge.ganttproject.task</a> ]
</div>

<h1>Coverage Summary for Class: TaskManagerImpl (net.sourceforge.ganttproject.task)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TaskManagerImpl</td>
<td class="coverageStat">
  <span class="percent">
    86.8%
  </span>
  <span class="absValue">
    (59/ 68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    71.3%
  </span>
  <span class="absValue">
    (251/ 352)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TaskManagerImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/ 3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$10</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    90%
  </span>
  <span class="absValue">
    (45/ 50)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$11</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$11$1</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (3/ 5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (3/ 5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$12</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/ 3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    60%
  </span>
  <span class="absValue">
    (3/ 5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$13</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80%
  </span>
  <span class="absValue">
    (4/ 5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$14</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/ 1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$3</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    16.7%
  </span>
  <span class="absValue">
    (1/ 6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$4</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/ 4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/ 7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$5</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/ 3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/ 4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$6</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$7</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$8</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$9</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$FacadeFactoryImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$FacadeImpl</td>
<td class="coverageStat">
  <span class="percent">
    81%
  </span>
  <span class="absValue">
    (17/ 21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.3%
  </span>
  <span class="absValue">
    (92/ 103)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$FacadeImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/ 2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/ 4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$TaskMap</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (9/ 9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (28/ 28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TaskManagerImpl$TaskNamePrefixOption</td>
<td class="coverageStat">
  <span class="percent">
    75%
  </span>
  <span class="absValue">
    (3/ 4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    71.4%
  </span>
  <span class="absValue">
    (5/ 7)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>total</strong></td>
<td class="coverageStat">
  <span class="percent">
    85.1%
  </span>
  <span class="absValue">
    (120/ 141)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    77.8%
  </span>
  <span class="absValue">
    (462/ 594)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<div class="sourceCode"><i>1</i>&nbsp;/*
<i>2</i>&nbsp; * Created on 05.07.2003
<i>3</i>&nbsp; *
<i>4</i>&nbsp; */
<i>5</i>&nbsp;package net.sourceforge.ganttproject.task;
<i>6</i>&nbsp;
<i>7</i>&nbsp;import biz.ganttproject.core.calendar.AlwaysWorkingTimeCalendarImpl;
<i>8</i>&nbsp;import biz.ganttproject.core.calendar.GPCalendarCalc;
<i>9</i>&nbsp;import biz.ganttproject.core.calendar.GPCalendarListener;
<i>10</i>&nbsp;import biz.ganttproject.core.chart.scene.BarChartActivity;
<i>11</i>&nbsp;import biz.ganttproject.core.chart.scene.gantt.ChartBoundsAlgorithm;
<i>12</i>&nbsp;import biz.ganttproject.core.chart.scene.gantt.ChartBoundsAlgorithm.Result;
<i>13</i>&nbsp;import biz.ganttproject.core.option.ColorOption;
<i>14</i>&nbsp;import biz.ganttproject.core.option.DefaultEnumerationOption;
<i>15</i>&nbsp;import biz.ganttproject.core.option.DefaultStringOption;
<i>16</i>&nbsp;import biz.ganttproject.core.option.EnumerationOption;
<i>17</i>&nbsp;import biz.ganttproject.core.option.StringOption;
<i>18</i>&nbsp;import biz.ganttproject.core.time.CalendarFactory;
<i>19</i>&nbsp;import biz.ganttproject.core.time.GanttCalendar;
<i>20</i>&nbsp;import biz.ganttproject.core.time.TimeDuration;
<i>21</i>&nbsp;import biz.ganttproject.core.time.TimeDurationImpl;
<i>22</i>&nbsp;import biz.ganttproject.core.time.TimeUnit;
<i>23</i>&nbsp;import biz.ganttproject.core.time.TimeUnitStack;
<i>24</i>&nbsp;import com.google.common.base.Function;
<i>25</i>&nbsp;import com.google.common.base.Preconditions;
<i>26</i>&nbsp;import com.google.common.base.Predicate;
<i>27</i>&nbsp;import com.google.common.base.Supplier;
<i>28</i>&nbsp;import com.google.common.collect.ImmutableList;
<i>29</i>&nbsp;import com.google.common.collect.Iterables;
<i>30</i>&nbsp;import com.google.common.collect.Lists;
<i>31</i>&nbsp;import com.google.common.collect.Queues;
<i>32</i>&nbsp;import net.sourceforge.ganttproject.CustomPropertyDefinition;
<i>33</i>&nbsp;import net.sourceforge.ganttproject.CustomPropertyListener;
<i>34</i>&nbsp;import net.sourceforge.ganttproject.CustomPropertyManager;
<i>35</i>&nbsp;import net.sourceforge.ganttproject.GPLogger;
<i>36</i>&nbsp;import net.sourceforge.ganttproject.GanttTask;
<i>37</i>&nbsp;import net.sourceforge.ganttproject.ProjectEventListener;
<i>38</i>&nbsp;import net.sourceforge.ganttproject.gui.NotificationChannel;
<i>39</i>&nbsp;import net.sourceforge.ganttproject.gui.NotificationItem;
<i>40</i>&nbsp;import net.sourceforge.ganttproject.gui.NotificationManager;
<i>41</i>&nbsp;import net.sourceforge.ganttproject.gui.options.model.GP1XOptionConverter;
<i>42</i>&nbsp;import net.sourceforge.ganttproject.language.GanttLanguage;
<i>43</i>&nbsp;import net.sourceforge.ganttproject.resource.HumanResource;
<i>44</i>&nbsp;import net.sourceforge.ganttproject.resource.HumanResourceManager;
<i>45</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.AdjustTaskBoundsAlgorithm;
<i>46</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.AlgorithmCollection;
<i>47</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.CriticalPathAlgorithm;
<i>48</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.CriticalPathAlgorithmImpl;
<i>49</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.DependencyGraph;
<i>50</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.FindPossibleDependeesAlgorithm;
<i>51</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.FindPossibleDependeesAlgorithmImpl;
<i>52</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.RecalculateTaskCompletionPercentageAlgorithm;
<i>53</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.RecalculateTaskScheduleAlgorithm;
<i>54</i>&nbsp;import net.sourceforge.ganttproject.task.algorithm.SchedulerImpl;
<i>55</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.EventDispatcher;
<i>56</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependency;
<i>57</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependency.Hardness;
<i>58</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependencyCollection;
<i>59</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependencyCollectionImpl;
<i>60</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependencyConstraint;
<i>61</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.TaskDependencyException;
<i>62</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.constraint.FinishFinishConstraintImpl;
<i>63</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.constraint.FinishStartConstraintImpl;
<i>64</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.constraint.StartFinishConstraintImpl;
<i>65</i>&nbsp;import net.sourceforge.ganttproject.task.dependency.constraint.StartStartConstraintImpl;
<i>66</i>&nbsp;import net.sourceforge.ganttproject.task.event.TaskDependencyEvent;
<i>67</i>&nbsp;import net.sourceforge.ganttproject.task.event.TaskHierarchyEvent;
<i>68</i>&nbsp;import net.sourceforge.ganttproject.task.event.TaskListener;
<i>69</i>&nbsp;import net.sourceforge.ganttproject.task.event.TaskPropertyEvent;
<i>70</i>&nbsp;import net.sourceforge.ganttproject.task.event.TaskScheduleEvent;
<i>71</i>&nbsp;import net.sourceforge.ganttproject.task.hierarchy.TaskHierarchyManagerImpl;
<i>72</i>&nbsp;import net.sourceforge.ganttproject.util.collect.Pair;
<i>73</i>&nbsp;
<i>74</i>&nbsp;import java.net.URL;
<i>75</i>&nbsp;import java.util.ArrayList;
<i>76</i>&nbsp;import java.util.Arrays;
<i>77</i>&nbsp;import java.util.Calendar;
<i>78</i>&nbsp;import java.util.Comparator;
<i>79</i>&nbsp;import java.util.Date;
<i>80</i>&nbsp;import java.util.HashMap;
<i>81</i>&nbsp;import java.util.LinkedHashMap;
<i>82</i>&nbsp;import java.util.LinkedList;
<i>83</i>&nbsp;import java.util.List;
<i>84</i>&nbsp;import java.util.Map;
<i>85</i>&nbsp;import java.util.Queue;
<i>86</i>&nbsp;import java.util.concurrent.atomic.AtomicInteger;
<i>87</i>&nbsp;
<i>88</i>&nbsp;/**
<i>89</i>&nbsp; * @author bard
<i>90</i>&nbsp; */
<b class="fc"><i>91</i>&nbsp;public class TaskManagerImpl implements TaskManager {</b>
<b class="fc"><i>92</i>&nbsp;  private static final GPCalendarCalc RESTLESS_CALENDAR = new AlwaysWorkingTimeCalendarImpl();</b>
<i>93</i>&nbsp;
<i>94</i>&nbsp;  private final TaskHierarchyManagerImpl myHierarchyManager;
<i>95</i>&nbsp;
<i>96</i>&nbsp;  private final TaskDependencyCollectionImpl myDependencyCollection;
<i>97</i>&nbsp;
<i>98</i>&nbsp;  private final AlgorithmCollection myAlgorithmCollection;
<i>99</i>&nbsp;
<b class="fc"><i>100</i>&nbsp;  private final List&lt;TaskListener&gt; myListeners = new ArrayList&lt;TaskListener&gt;();</b>
<i>101</i>&nbsp;
<b class="fc"><i>102</i>&nbsp;  private AtomicInteger myMaxID = new AtomicInteger(0);</b>
<i>103</i>&nbsp;
<i>104</i>&nbsp;  private final Task myRoot;
<i>105</i>&nbsp;
<i>106</i>&nbsp;  private final TaskManagerConfig myConfig;
<i>107</i>&nbsp;
<b class="fc"><i>108</i>&nbsp;  private final TaskNamePrefixOption myTaskNamePrefixOption = new TaskNamePrefixOption();</b>
<i>109</i>&nbsp;
<b class="fc"><i>110</i>&nbsp;  private final StringOption myTaskCopyNamePrefixOption = new DefaultStringOption(&quot;taskCopyNamePrefix&quot;, GanttLanguage.getInstance().getText(&quot;task.copy.prefix&quot;));</b>
<i>111</i>&nbsp;
<b class="fc"><i>112</i>&nbsp;  private final EnumerationOption myDependencyHardnessOption = new DefaultEnumerationOption&lt;Object&gt;(</b>
<b class="fc"><i>113</i>&nbsp;      &quot;dependencyDefaultHardness&quot;, new String[] { &quot;Strong&quot;, &quot;Rubber&quot; }) {</b>
<i>114</i>&nbsp;    {
<b class="fc"><i>115</i>&nbsp;      resetValue(&quot;Strong&quot;, true);</b>
<b class="fc"><i>116</i>&nbsp;    }</b>
<i>117</i>&nbsp;  };
<i>118</i>&nbsp;
<i>119</i>&nbsp;  private final TaskContainmentHierarchyFacade.Factory myFacadeFactory;
<i>120</i>&nbsp;
<b class="fc"><i>121</i>&nbsp;  private final Supplier&lt;TaskContainmentHierarchyFacade&gt; myHierarchySupplier = new Supplier&lt;TaskContainmentHierarchyFacade&gt;() {</b>
<i>122</i>&nbsp;    @Override
<i>123</i>&nbsp;    public TaskContainmentHierarchyFacade get() {
<b class="fc"><i>124</i>&nbsp;      return getTaskHierarchy();</b>
<i>125</i>&nbsp;    }
<i>126</i>&nbsp;  };
<b class="fc"><i>127</i>&nbsp;  private final DependencyGraph myDependencyGraph = new DependencyGraph(myHierarchySupplier, new DependencyGraph.Logger() {</b>
<i>128</i>&nbsp;    @Override
<i>129</i>&nbsp;    public void logDependencyLoop(String title, String message) {
<b class="nc"><i>130</i>&nbsp;      if (myConfig.getNotificationManager() != null) {</b>
<b class="nc"><i>131</i>&nbsp;        myConfig.getNotificationManager().addNotifications(NotificationChannel.WARNING,</b>
<b class="nc"><i>132</i>&nbsp;            ImmutableList.of(new NotificationItem(&quot;Dependency loop detected&quot;, message, NotificationManager.DEFAULT_HYPERLINK_LISTENER)));</b>
<i>133</i>&nbsp;      }
<b class="nc"><i>134</i>&nbsp;      GPLogger.log(title + &quot;\n&quot; + message);</b>
<b class="nc"><i>135</i>&nbsp;    }</b>
<i>136</i>&nbsp;  });
<i>137</i>&nbsp;
<b class="fc"><i>138</i>&nbsp;  private final SchedulerImpl myScheduler = new SchedulerImpl(myDependencyGraph, myHierarchySupplier);</b>
<i>139</i>&nbsp;
<b class="fc"><i>140</i>&nbsp;  private boolean areEventsEnabled = true;</b>
<i>141</i>&nbsp;
<i>142</i>&nbsp;  private static class TaskMap {
<b class="fc"><i>143</i>&nbsp;    private final Map&lt;Integer, Task&gt; myId2task = new HashMap&lt;Integer, Task&gt;();</b>
<i>144</i>&nbsp;    private TaskDocumentOrderComparator myComparator;
<b class="fc"><i>145</i>&nbsp;    private boolean isModified = true;</b>
<i>146</i>&nbsp;    private Task[] myArray;
<i>147</i>&nbsp;    private final TaskManagerImpl myManager;
<i>148</i>&nbsp;
<b class="fc"><i>149</i>&nbsp;    TaskMap(TaskManagerImpl taskManager) {</b>
<b class="fc"><i>150</i>&nbsp;      myComparator = new TaskDocumentOrderComparator(taskManager);</b>
<b class="fc"><i>151</i>&nbsp;      myManager = taskManager;</b>
<b class="fc"><i>152</i>&nbsp;    }</b>
<i>153</i>&nbsp;
<i>154</i>&nbsp;    void addTask(Task task) {
<b class="fc"><i>155</i>&nbsp;      myId2task.put(new Integer(task.getTaskID()), task);</b>
<b class="fc"><i>156</i>&nbsp;      isModified = true;</b>
<b class="fc"><i>157</i>&nbsp;    }</b>
<i>158</i>&nbsp;
<i>159</i>&nbsp;    Task getTask(int id) {
<b class="fc"><i>160</i>&nbsp;      return myId2task.get(new Integer(id));</b>
<i>161</i>&nbsp;    }
<i>162</i>&nbsp;
<i>163</i>&nbsp;    public Task[] getTasks() {
<b class="fc"><i>164</i>&nbsp;      if (isModified) {</b>
<b class="fc"><i>165</i>&nbsp;        myArray = myId2task.values().toArray(new Task[myId2task.size()]);</b>
<b class="fc"><i>166</i>&nbsp;        Arrays.sort(myArray, myComparator);</b>
<b class="fc"><i>167</i>&nbsp;        isModified = false;</b>
<i>168</i>&nbsp;      }
<b class="fc"><i>169</i>&nbsp;      return myArray;</b>
<i>170</i>&nbsp;    }
<i>171</i>&nbsp;
<i>172</i>&nbsp;    public void clear() {
<b class="fc"><i>173</i>&nbsp;      myId2task.clear();</b>
<b class="fc"><i>174</i>&nbsp;      isModified = true;</b>
<b class="fc"><i>175</i>&nbsp;    }</b>
<i>176</i>&nbsp;
<i>177</i>&nbsp;    public void removeTask(Task task) {
<b class="fc"><i>178</i>&nbsp;      myId2task.remove(new Integer(task.getTaskID()));</b>
<b class="fc"><i>179</i>&nbsp;      Task[] nestedTasks = myManager.getTaskHierarchy().getNestedTasks(task);</b>
<b class="fc"><i>180</i>&nbsp;      for (int i = 0; i &lt; nestedTasks.length; i++) {</b>
<b class="fc"><i>181</i>&nbsp;        removeTask(nestedTasks[i]);</b>
<i>182</i>&nbsp;      }
<b class="fc"><i>183</i>&nbsp;      isModified = true;</b>
<b class="fc"><i>184</i>&nbsp;    }</b>
<i>185</i>&nbsp;
<i>186</i>&nbsp;    public int size() {
<b class="fc"><i>187</i>&nbsp;      return myId2task.size();</b>
<i>188</i>&nbsp;    }
<i>189</i>&nbsp;
<i>190</i>&nbsp;    public boolean isEmpty() {
<b class="fc"><i>191</i>&nbsp;      return myId2task.isEmpty();</b>
<i>192</i>&nbsp;    }
<i>193</i>&nbsp;
<i>194</i>&nbsp;    void setDirty() {
<b class="fc"><i>195</i>&nbsp;      isModified = true;</b>
<b class="fc"><i>196</i>&nbsp;    }</b>
<i>197</i>&nbsp;  }
<i>198</i>&nbsp;
<b class="fc"><i>199</i>&nbsp;  private final TaskMap myTaskMap = new TaskMap(this);</b>
<i>200</i>&nbsp;
<i>201</i>&nbsp;  private final CustomPropertyListenerImpl myCustomPropertyListener;
<i>202</i>&nbsp;
<i>203</i>&nbsp;  private final CustomColumnsManager myCustomColumnsManager;
<i>204</i>&nbsp;
<b class="fc"><i>205</i>&nbsp;  private Boolean isZeroMilestones = true;</b>
<i>206</i>&nbsp;
<b class="fc"><i>207</i>&nbsp;  TaskManagerImpl(TaskContainmentHierarchyFacade.Factory containmentFacadeFactory, TaskManagerConfig config) {</b>
<b class="fc"><i>208</i>&nbsp;    myCustomPropertyListener = new CustomPropertyListenerImpl(this);</b>
<b class="fc"><i>209</i>&nbsp;    myCustomColumnsManager = new CustomColumnsManager();</b>
<b class="fc"><i>210</i>&nbsp;    myCustomColumnsManager.addListener(getCustomPropertyListener());</b>
<i>211</i>&nbsp;
<b class="fc"><i>212</i>&nbsp;    myConfig = config;</b>
<b class="fc"><i>213</i>&nbsp;    myHierarchyManager = new TaskHierarchyManagerImpl();</b>
<b class="fc"><i>214</i>&nbsp;    EventDispatcher dispatcher = new EventDispatcher() {</b>
<i>215</i>&nbsp;      @Override
<i>216</i>&nbsp;      public void fireDependencyAdded(TaskDependency dep) {
<b class="fc"><i>217</i>&nbsp;        TaskManagerImpl.this.fireDependencyAdded(dep);</b>
<b class="fc"><i>218</i>&nbsp;      }</b>
<i>219</i>&nbsp;      @Override
<i>220</i>&nbsp;      public void fireDependencyRemoved(TaskDependency dep) {
<b class="fc"><i>221</i>&nbsp;        TaskManagerImpl.this.fireDependencyRemoved(dep);</b>
<b class="fc"><i>222</i>&nbsp;      }</b>
<i>223</i>&nbsp;      @Override
<i>224</i>&nbsp;      public void fireDependencyChanged(TaskDependency dep) {
<b class="fc"><i>225</i>&nbsp;        TaskManagerImpl.this.fireDependencyChanged(dep);</b>
<b class="fc"><i>226</i>&nbsp;      }</b>
<i>227</i>&nbsp;    };
<b class="fc"><i>228</i>&nbsp;    myDependencyCollection = new TaskDependencyCollectionImpl(containmentFacadeFactory, dispatcher) {</b>
<i>229</i>&nbsp;      @Override
<i>230</i>&nbsp;      protected TaskContainmentHierarchyFacade getTaskHierarchy() {
<b class="fc"><i>231</i>&nbsp;        return TaskManagerImpl.this.getTaskHierarchy();</b>
<i>232</i>&nbsp;      }
<i>233</i>&nbsp;
<i>234</i>&nbsp;      @Override
<i>235</i>&nbsp;      protected Hardness getDefaultHardness() {
<b class="fc"><i>236</i>&nbsp;        String optionValue = getDependencyHardnessOption().getValue();</b>
<b class="fc"><i>237</i>&nbsp;        return optionValue == null ? super.getDefaultHardness() : TaskDependency.Hardness.parse(optionValue);</b>
<i>238</i>&nbsp;      }
<i>239</i>&nbsp;
<i>240</i>&nbsp;    };
<b class="fc"><i>241</i>&nbsp;    myFacadeFactory = containmentFacadeFactory == null ? new FacadeFactoryImpl() : containmentFacadeFactory;</b>
<i>242</i>&nbsp;    // clear();
<b class="fc"><i>243</i>&nbsp;    myRoot = createRootTask();</b>
<i>244</i>&nbsp;
<b class="fc"><i>245</i>&nbsp;    FindPossibleDependeesAlgorithm alg1 = new FindPossibleDependeesAlgorithmImpl() {</b>
<i>246</i>&nbsp;      @Override
<i>247</i>&nbsp;      protected TaskContainmentHierarchyFacade createContainmentFacade() {
<b class="nc"><i>248</i>&nbsp;        return TaskManagerImpl.this.getTaskHierarchy();</b>
<i>249</i>&nbsp;      }
<i>250</i>&nbsp;
<i>251</i>&nbsp;    };
<b class="fc"><i>252</i>&nbsp;    AdjustTaskBoundsAlgorithm alg3 = new AdjustTaskBoundsAlgorithm() {</b>
<i>253</i>&nbsp;      @Override
<i>254</i>&nbsp;      protected TaskContainmentHierarchyFacade createContainmentFacade() {
<b class="nc"><i>255</i>&nbsp;        return TaskManagerImpl.this.getTaskHierarchy();</b>
<i>256</i>&nbsp;      }
<i>257</i>&nbsp;    };
<b class="fc"><i>258</i>&nbsp;    RecalculateTaskScheduleAlgorithm alg2 = new RecalculateTaskScheduleAlgorithm(alg3) {</b>
<i>259</i>&nbsp;      @Override
<i>260</i>&nbsp;      protected TaskContainmentHierarchyFacade createContainmentFacade() {
<b class="nc"><i>261</i>&nbsp;        return TaskManagerImpl.this.getTaskHierarchy();</b>
<i>262</i>&nbsp;      }
<i>263</i>&nbsp;    };
<b class="fc"><i>264</i>&nbsp;    RecalculateTaskCompletionPercentageAlgorithm alg4 = new RecalculateTaskCompletionPercentageAlgorithm() {</b>
<i>265</i>&nbsp;      @Override
<i>266</i>&nbsp;      protected TaskContainmentHierarchyFacade createContainmentFacade() {
<b class="fc"><i>267</i>&nbsp;        return TaskManagerImpl.this.getTaskHierarchy();</b>
<i>268</i>&nbsp;      }
<i>269</i>&nbsp;    };
<b class="fc"><i>270</i>&nbsp;    ChartBoundsAlgorithm alg5 = new ChartBoundsAlgorithm();</b>
<b class="fc"><i>271</i>&nbsp;    CriticalPathAlgorithm alg6 = new CriticalPathAlgorithmImpl(this, getCalendar());</b>
<b class="fc"><i>272</i>&nbsp;    myAlgorithmCollection = new AlgorithmCollection(this, alg1, alg2, alg3, alg4, alg5, alg6, myScheduler);</b>
<b class="fc"><i>273</i>&nbsp;    addTaskListener(myScheduler.getTaskModelListener());</b>
<b class="fc"><i>274</i>&nbsp;  }</b>
<i>275</i>&nbsp;
<i>276</i>&nbsp;  private CustomPropertyListener getCustomPropertyListener() {
<b class="fc"><i>277</i>&nbsp;    return myCustomPropertyListener;</b>
<i>278</i>&nbsp;  }
<i>279</i>&nbsp;
<i>280</i>&nbsp;  @Override
<i>281</i>&nbsp;  public GanttTask getTask(int taskId) {
<b class="fc"><i>282</i>&nbsp;    return (GanttTask) myTaskMap.getTask(taskId);</b>
<i>283</i>&nbsp;  }
<i>284</i>&nbsp;
<i>285</i>&nbsp;  @Override
<i>286</i>&nbsp;  public Task getRootTask() {
<b class="fc"><i>287</i>&nbsp;    return myRoot;</b>
<i>288</i>&nbsp;  }
<i>289</i>&nbsp;
<i>290</i>&nbsp;  @Override
<i>291</i>&nbsp;  public Task[] getTasks() {
<b class="fc"><i>292</i>&nbsp;    return myTaskMap.getTasks();</b>
<i>293</i>&nbsp;  }
<i>294</i>&nbsp;
<i>295</i>&nbsp;  private Task createRootTask() {
<b class="fc"><i>296</i>&nbsp;    Calendar c = CalendarFactory.newCalendar();</b>
<b class="fc"><i>297</i>&nbsp;    Date today = c.getTime();</b>
<b class="fc"><i>298</i>&nbsp;    Task root = new GanttTask(null, CalendarFactory.createGanttCalendar(today), 1, this, -1);</b>
<b class="fc"><i>299</i>&nbsp;    root.setStart(CalendarFactory.createGanttCalendar(today));</b>
<b class="fc"><i>300</i>&nbsp;    root.setDuration(createLength(getConfig().getTimeUnitStack().getDefaultTimeUnit(), 1));</b>
<b class="fc"><i>301</i>&nbsp;    root.setExpand(true);</b>
<b class="fc"><i>302</i>&nbsp;    root.setName(&quot;root&quot;);</b>
<b class="fc"><i>303</i>&nbsp;    return root;</b>
<i>304</i>&nbsp;  }
<i>305</i>&nbsp;
<i>306</i>&nbsp;  private void projectClosed() {
<b class="fc"><i>307</i>&nbsp;    myDependencyGraph.clear();</b>
<b class="fc"><i>308</i>&nbsp;    myTaskMap.clear();</b>
<b class="fc"><i>309</i>&nbsp;    myMaxID.set(0);</b>
<b class="fc"><i>310</i>&nbsp;    myDependencyCollection.clear();</b>
<i>311</i>&nbsp;    // createRootTask();
<b class="fc"><i>312</i>&nbsp;    fireTaskModelReset();</b>
<b class="fc"><i>313</i>&nbsp;  }</b>
<i>314</i>&nbsp;
<i>315</i>&nbsp;  private void projectOpened() {
<b class="nc"><i>316</i>&nbsp;    processCriticalPath(getRootTask());</b>
<b class="nc"><i>317</i>&nbsp;    myAlgorithmCollection.getRecalculateTaskCompletionPercentageAlgorithm().run();</b>
<b class="nc"><i>318</i>&nbsp;  }</b>
<i>319</i>&nbsp;
<i>320</i>&nbsp;  @Override
<i>321</i>&nbsp;  public void deleteTask(Task tasktoRemove) {
<b class="fc"><i>322</i>&nbsp;    Task[] nestedTasks = getTaskHierarchy().getDeepNestedTasks(tasktoRemove);</b>
<b class="fc"><i>323</i>&nbsp;    for (Task t : nestedTasks) {</b>
<b class="fc"><i>324</i>&nbsp;      t.delete();</b>
<i>325</i>&nbsp;    }
<b class="fc"><i>326</i>&nbsp;    Task container = getTaskHierarchy().getContainer(tasktoRemove);</b>
<b class="fc"><i>327</i>&nbsp;    myTaskMap.removeTask(tasktoRemove);</b>
<b class="fc"><i>328</i>&nbsp;    tasktoRemove.delete();</b>
<b class="fc"><i>329</i>&nbsp;    fireTaskRemoved(container, tasktoRemove);</b>
<b class="fc"><i>330</i>&nbsp;  }</b>
<i>331</i>&nbsp;
<i>332</i>&nbsp;  @Override
<i>333</i>&nbsp;  public GanttTask createTask() {
<b class="fc"><i>334</i>&nbsp;    return (GanttTask) newTaskBuilder().build();</b>
<i>335</i>&nbsp;  }
<i>336</i>&nbsp;
<i>337</i>&nbsp;  @Override
<i>338</i>&nbsp;  public GanttTask createTask(int id) {
<b class="fc"><i>339</i>&nbsp;    return (GanttTask) newTaskBuilder().withId(id).build();</b>
<i>340</i>&nbsp;  }
<i>341</i>&nbsp;
<i>342</i>&nbsp;  @Override
<i>343</i>&nbsp;  public TaskBuilder newTaskBuilder() {
<b class="fc"><i>344</i>&nbsp;    return new TaskBuilder() {</b>
<i>345</i>&nbsp;      @Override
<i>346</i>&nbsp;      public Task build() {
<i>347</i>&nbsp;
<b class="fc"><i>348</i>&nbsp;        if (myId == null || myTaskMap.getTask(myId) != null) {</b>
<b class="fc"><i>349</i>&nbsp;          myId = getAndIncrementId();</b>
<i>350</i>&nbsp;        }
<i>351</i>&nbsp;
<b class="fc"><i>352</i>&nbsp;        TaskImpl task = myPrototype == null</b>
<b class="fc"><i>353</i>&nbsp;            ? new GanttTask(&quot;&quot;, CalendarFactory.createGanttCalendar(), 1, TaskManagerImpl.this, myId)</b>
<b class="fc"><i>354</i>&nbsp;            : new GanttTask(TaskManagerImpl.this, (TaskImpl)myPrototype);</b>
<i>355</i>&nbsp;
<b class="fc"><i>356</i>&nbsp;        if (myPrototype == null) {</b>
<b class="fc"><i>357</i>&nbsp;          String name = myName == null</b>
<b class="fc"><i>358</i>&nbsp;              ? getTaskNamePrefixOption().getValue() + &quot;_&quot; + task.getTaskID() : myName;</b>
<b class="fc"><i>359</i>&nbsp;          task.setName(name);</b>
<b class="fc"><i>360</i>&nbsp;        } else if (myName != null) {</b>
<b class="fc"><i>361</i>&nbsp;          task.setName(myName);</b>
<i>362</i>&nbsp;        }
<b class="fc"><i>363</i>&nbsp;        if (myStartDate != null) {</b>
<b class="fc"><i>364</i>&nbsp;          GanttCalendar cal = CalendarFactory.createGanttCalendar(myStartDate);</b>
<b class="fc"><i>365</i>&nbsp;          task.setStart(cal);</b>
<i>366</i>&nbsp;        }
<i>367</i>&nbsp;        TimeDuration duration;
<b class="fc"><i>368</i>&nbsp;        if (myDuration != null) {</b>
<b class="fc"><i>369</i>&nbsp;          duration = myDuration;</b>
<b class="fc"><i>370</i>&nbsp;        } else if (myPrototype != null) {</b>
<b class="fc"><i>371</i>&nbsp;          duration = myPrototype.getDuration();</b>
<i>372</i>&nbsp;        } else {
<b class="fc"><i>373</i>&nbsp;          duration = (myEndDate == null)</b>
<b class="fc"><i>374</i>&nbsp;              ? createLength(getTimeUnitStack().getDefaultTimeUnit(), 1.0f)</b>
<b class="nc"><i>375</i>&nbsp;                  : createLength(getTimeUnitStack().getDefaultTimeUnit(), myStartDate, myEndDate);</b>
<i>376</i>&nbsp;        }
<b class="fc"><i>377</i>&nbsp;        task.setDuration(duration);</b>
<i>378</i>&nbsp;
<b class="fc"><i>379</i>&nbsp;        if (myColor != null) {</b>
<b class="fc"><i>380</i>&nbsp;          task.setColor(myColor);</b>
<i>381</i>&nbsp;        }
<b class="fc"><i>382</i>&nbsp;        if (myPriority != null) {</b>
<b class="fc"><i>383</i>&nbsp;          task.setPriority(myPriority);</b>
<i>384</i>&nbsp;        }
<b class="fc"><i>385</i>&nbsp;        if (isExpanded != null) {</b>
<b class="nc"><i>386</i>&nbsp;          task.setExpand(isExpanded);</b>
<i>387</i>&nbsp;        }
<b class="fc"><i>388</i>&nbsp;        if (myNotes != null) {</b>
<b class="fc"><i>389</i>&nbsp;          task.setNotes(myNotes);</b>
<i>390</i>&nbsp;        }
<b class="fc"><i>391</i>&nbsp;        if (myWebLink != null) {</b>
<b class="fc"><i>392</i>&nbsp;          task.setWebLink(myWebLink);</b>
<i>393</i>&nbsp;        }
<b class="fc"><i>394</i>&nbsp;        if (myCompletion != null) {</b>
<b class="fc"><i>395</i>&nbsp;          task.setCompletionPercentage(myCompletion);</b>
<i>396</i>&nbsp;        }
<b class="fc"><i>397</i>&nbsp;        if (myCost != null) {</b>
<b class="nc"><i>398</i>&nbsp;          task.getCost().setCalculated(false);</b>
<b class="nc"><i>399</i>&nbsp;          task.getCost().setValue(myCost);</b>
<i>400</i>&nbsp;        }
<b class="fc"><i>401</i>&nbsp;        registerTask(task);</b>
<i>402</i>&nbsp;
<i>403</i>&nbsp;
<b class="fc"><i>404</i>&nbsp;        if (myPrevSibling != null &amp;&amp; myPrevSibling != getRootTask()) {</b>
<b class="fc"><i>405</i>&nbsp;          int position = getTaskHierarchy().getTaskIndex(myPrevSibling) + 1;</b>
<b class="fc"><i>406</i>&nbsp;          Task parentTask = getTaskHierarchy().getContainer(myPrevSibling);</b>
<b class="fc"><i>407</i>&nbsp;          getTaskHierarchy().move(task, parentTask, position);</b>
<b class="fc"><i>408</i>&nbsp;        } else {</b>
<b class="fc"><i>409</i>&nbsp;          Task parentTask = myParent == null ? getRootTask() : myParent;</b>
<b class="fc"><i>410</i>&nbsp;          getTaskHierarchy().move(task, parentTask);</b>
<i>411</i>&nbsp;        }
<i>412</i>&nbsp;
<b class="fc"><i>413</i>&nbsp;        if (isLegacyMilestone) {</b>
<b class="nc"><i>414</i>&nbsp;          task.setMilestone(isLegacyMilestone);</b>
<i>415</i>&nbsp;        }
<b class="fc"><i>416</i>&nbsp;        fireTaskAdded(task);</b>
<b class="fc"><i>417</i>&nbsp;        return task;</b>
<i>418</i>&nbsp;      }
<i>419</i>&nbsp;    };
<i>420</i>&nbsp;  }
<i>421</i>&nbsp;
<i>422</i>&nbsp;  protected TimeUnitStack getTimeUnitStack() {
<b class="fc"><i>423</i>&nbsp;    return getConfig().getTimeUnitStack();</b>
<i>424</i>&nbsp;  }
<i>425</i>&nbsp;
<i>426</i>&nbsp;  int getAndIncrementId() {
<b class="fc"><i>427</i>&nbsp;    return myMaxID.getAndIncrement();</b>
<i>428</i>&nbsp;  }
<i>429</i>&nbsp;
<i>430</i>&nbsp;  @Override
<i>431</i>&nbsp;  public void registerTask(Task task) {
<b class="fc"><i>432</i>&nbsp;    int taskID = task.getTaskID();</b>
<b class="fc"><i>433</i>&nbsp;    assert myTaskMap.getTask(taskID) == null : &quot;There is a task that already has the ID &quot; + taskID;</b>
<b class="fc"><i>434</i>&nbsp;    myTaskMap.addTask(task);</b>
<b class="fc"><i>435</i>&nbsp;    myMaxID.set(Math.max(taskID + 1, myMaxID.get()));</b>
<b class="fc"><i>436</i>&nbsp;    myDependencyGraph.addTask(task);</b>
<b class="fc"><i>437</i>&nbsp;  }</b>
<i>438</i>&nbsp;
<i>439</i>&nbsp;  boolean isRegistered(TaskImpl task) {
<b class="fc"><i>440</i>&nbsp;    return myTaskMap.getTask(task.getTaskID()) != null;</b>
<i>441</i>&nbsp;  }
<i>442</i>&nbsp;
<i>443</i>&nbsp;  @Override
<i>444</i>&nbsp;  public int getTaskCount() {
<b class="fc"><i>445</i>&nbsp;    return myTaskMap.size();</b>
<i>446</i>&nbsp;  }
<i>447</i>&nbsp;
<i>448</i>&nbsp;  private static Iterable&lt;BarChartActivity&lt;?&gt;&gt; tasksToActivities(Task[] tasks) {
<b class="fc"><i>449</i>&nbsp;    return Iterables.transform(Arrays.asList(tasks), new Function&lt;Task, BarChartActivity&lt;?&gt;&gt;() {</b>
<i>450</i>&nbsp;      @Override
<i>451</i>&nbsp;      public BarChartActivity&lt;?&gt; apply(final Task task) {
<b class="fc"><i>452</i>&nbsp;        return new BarChartActivity&lt;Task&gt;() {</b>
<i>453</i>&nbsp;          @Override
<i>454</i>&nbsp;          public Date getStart() {
<b class="fc"><i>455</i>&nbsp;            return task.getStart().getTime();</b>
<i>456</i>&nbsp;          }
<i>457</i>&nbsp;          @Override
<i>458</i>&nbsp;          public Date getEnd() {
<b class="fc"><i>459</i>&nbsp;            return task.getEnd().getTime();</b>
<i>460</i>&nbsp;          }
<i>461</i>&nbsp;          @Override
<i>462</i>&nbsp;          public TimeDuration getDuration() {
<b class="nc"><i>463</i>&nbsp;            return task.getDuration();</b>
<i>464</i>&nbsp;          }
<i>465</i>&nbsp;          @Override
<i>466</i>&nbsp;          public Task getOwner() {
<b class="nc"><i>467</i>&nbsp;            return task;</b>
<i>468</i>&nbsp;          }
<i>469</i>&nbsp;        };
<i>470</i>&nbsp;      }
<i>471</i>&nbsp;    });
<i>472</i>&nbsp;  }
<i>473</i>&nbsp;
<i>474</i>&nbsp;  @Override
<i>475</i>&nbsp;  public TimeDuration getProjectLength() {
<b class="nc"><i>476</i>&nbsp;    if (myTaskMap.isEmpty()) {</b>
<b class="nc"><i>477</i>&nbsp;      return createLength(getConfig().getTimeUnitStack().getDefaultTimeUnit(), 0);</b>
<i>478</i>&nbsp;    }
<b class="nc"><i>479</i>&nbsp;    Result result = getAlgorithmCollection().getProjectBoundsAlgorithm().getBounds(tasksToActivities(myTaskMap.getTasks()));</b>
<b class="nc"><i>480</i>&nbsp;    return createLength(getConfig().getTimeUnitStack().getDefaultTimeUnit(), result.lowerBound, result.upperBound);</b>
<i>481</i>&nbsp;  }
<i>482</i>&nbsp;
<i>483</i>&nbsp;  @Override
<i>484</i>&nbsp;  public Date getProjectStart() {
<b class="fc"><i>485</i>&nbsp;    if (myTaskMap.isEmpty()) {</b>
<b class="nc"><i>486</i>&nbsp;      return myRoot.getStart().getTime();</b>
<i>487</i>&nbsp;    }
<b class="fc"><i>488</i>&nbsp;    Result result = getAlgorithmCollection().getProjectBoundsAlgorithm().getBounds(tasksToActivities(myTaskMap.getTasks()));</b>
<b class="fc"><i>489</i>&nbsp;    return result.lowerBound;</b>
<i>490</i>&nbsp;  }
<i>491</i>&nbsp;
<i>492</i>&nbsp;  @Override
<i>493</i>&nbsp;  public Date getProjectEnd() {
<b class="fc"><i>494</i>&nbsp;    if (myTaskMap.isEmpty()) {</b>
<b class="nc"><i>495</i>&nbsp;      return myRoot.getStart().getTime();</b>
<i>496</i>&nbsp;    }
<b class="fc"><i>497</i>&nbsp;    Result result = getAlgorithmCollection().getProjectBoundsAlgorithm().getBounds(tasksToActivities(myTaskMap.getTasks()));</b>
<b class="fc"><i>498</i>&nbsp;    return result.upperBound;</b>
<i>499</i>&nbsp;  }
<i>500</i>&nbsp;
<i>501</i>&nbsp;  @Override
<i>502</i>&nbsp;  public int getProjectCompletion() {
<b class="nc"><i>503</i>&nbsp;    return myRoot.getCompletionPercentage();</b>
<i>504</i>&nbsp;  }
<i>505</i>&nbsp;
<i>506</i>&nbsp;  @Override
<i>507</i>&nbsp;  public String encode(TimeDuration taskLength) {
<b class="nc"><i>508</i>&nbsp;    StringBuffer result = new StringBuffer(String.valueOf(taskLength.getLength()));</b>
<b class="nc"><i>509</i>&nbsp;    result.append(myConfig.getTimeUnitStack().encode(taskLength.getTimeUnit()));</b>
<b class="nc"><i>510</i>&nbsp;    return result.toString();</b>
<i>511</i>&nbsp;  }
<i>512</i>&nbsp;
<i>513</i>&nbsp;  @Override
<i>514</i>&nbsp;  public TimeDuration createLength(String lengthAsString) throws DurationParsingException {
<b class="fc"><i>515</i>&nbsp;    int state = 0;</b>
<b class="fc"><i>516</i>&nbsp;    StringBuffer valueBuffer = new StringBuffer();</b>
<b class="fc"><i>517</i>&nbsp;    Integer currentValue = null;</b>
<b class="fc"><i>518</i>&nbsp;    TimeDuration currentLength = null;</b>
<b class="fc"><i>519</i>&nbsp;    lengthAsString += &quot; &quot;;</b>
<b class="fc"><i>520</i>&nbsp;    for (int i = 0; i &lt; lengthAsString.length(); i++) {</b>
<b class="fc"><i>521</i>&nbsp;      char nextChar = lengthAsString.charAt(i);</b>
<b class="fc"><i>522</i>&nbsp;      if (Character.isDigit(nextChar)) {</b>
<b class="fc"><i>523</i>&nbsp;        switch (state) {</b>
<i>524</i>&nbsp;        case 0:
<b class="fc"><i>525</i>&nbsp;          if (currentValue != null) {</b>
<b class="nc"><i>526</i>&nbsp;            throw new DurationParsingException();</b>
<i>527</i>&nbsp;          }
<b class="fc"><i>528</i>&nbsp;          state = 1;</b>
<b class="fc"><i>529</i>&nbsp;          valueBuffer.setLength(0);</b>
<i>530</i>&nbsp;        case 1:
<b class="fc"><i>531</i>&nbsp;          valueBuffer.append(nextChar);</b>
<b class="fc"><i>532</i>&nbsp;          break;</b>
<i>533</i>&nbsp;        case 2:
<b class="nc"><i>534</i>&nbsp;          TimeUnit timeUnit = findTimeUnit(valueBuffer.toString());</b>
<b class="nc"><i>535</i>&nbsp;          if (timeUnit == null) {</b>
<b class="nc"><i>536</i>&nbsp;            throw new DurationParsingException(valueBuffer.toString());</b>
<i>537</i>&nbsp;          }
<b class="nc"><i>538</i>&nbsp;          assert currentValue != null;</b>
<b class="nc"><i>539</i>&nbsp;          TimeDuration localResult = createLength(timeUnit, currentValue.floatValue());</b>
<b class="nc"><i>540</i>&nbsp;          if (currentLength == null) {</b>
<b class="nc"><i>541</i>&nbsp;            currentLength = localResult;</b>
<i>542</i>&nbsp;          } else {
<b class="nc"><i>543</i>&nbsp;            if (currentLength.getTimeUnit().isConstructedFrom(timeUnit)) {</b>
<b class="nc"><i>544</i>&nbsp;              float recalculatedLength = currentLength.getLength(timeUnit);</b>
<b class="nc"><i>545</i>&nbsp;              currentLength = createLength(timeUnit, localResult.getValue() + recalculatedLength);</b>
<b class="nc"><i>546</i>&nbsp;            } else {</b>
<b class="nc"><i>547</i>&nbsp;              throw new DurationParsingException();</b>
<i>548</i>&nbsp;            }
<i>549</i>&nbsp;          }
<b class="nc"><i>550</i>&nbsp;          state = 1;</b>
<b class="nc"><i>551</i>&nbsp;          currentValue = null;</b>
<b class="nc"><i>552</i>&nbsp;          valueBuffer.setLength(0);</b>
<b class="nc"><i>553</i>&nbsp;          valueBuffer.append(nextChar);</b>
<b class="fc"><i>554</i>&nbsp;          break;</b>
<i>555</i>&nbsp;        }
<b class="fc"><i>556</i>&nbsp;      } else if (Character.isWhitespace(nextChar)) {</b>
<b class="fc"><i>557</i>&nbsp;        switch (state) {</b>
<i>558</i>&nbsp;        case 0:
<b class="nc"><i>559</i>&nbsp;          break;</b>
<i>560</i>&nbsp;        case 1:
<b class="nc"><i>561</i>&nbsp;          currentValue = Integer.valueOf(valueBuffer.toString());</b>
<b class="nc"><i>562</i>&nbsp;          state = 0;</b>
<b class="nc"><i>563</i>&nbsp;          break;</b>
<i>564</i>&nbsp;        case 2:
<b class="fc"><i>565</i>&nbsp;          TimeUnit timeUnit = findTimeUnit(valueBuffer.toString());</b>
<b class="fc"><i>566</i>&nbsp;          if (timeUnit == null) {</b>
<b class="nc"><i>567</i>&nbsp;            throw new DurationParsingException(valueBuffer.toString());</b>
<i>568</i>&nbsp;          }
<b class="fc"><i>569</i>&nbsp;          assert currentValue != null;</b>
<b class="fc"><i>570</i>&nbsp;          TimeDuration localResult = createLength(timeUnit, currentValue.floatValue());</b>
<b class="fc"><i>571</i>&nbsp;          if (currentLength == null) {</b>
<b class="fc"><i>572</i>&nbsp;            currentLength = localResult;</b>
<i>573</i>&nbsp;          } else {
<b class="nc"><i>574</i>&nbsp;            if (currentLength.getTimeUnit().isConstructedFrom(timeUnit)) {</b>
<b class="nc"><i>575</i>&nbsp;              float recalculatedLength = currentLength.getLength(timeUnit);</b>
<b class="nc"><i>576</i>&nbsp;              currentLength = createLength(timeUnit, localResult.getValue() + recalculatedLength);</b>
<b class="nc"><i>577</i>&nbsp;            } else {</b>
<b class="nc"><i>578</i>&nbsp;              throw new DurationParsingException();</b>
<i>579</i>&nbsp;            }
<i>580</i>&nbsp;          }
<b class="fc"><i>581</i>&nbsp;          state = 0;</b>
<b class="fc"><i>582</i>&nbsp;          currentValue = null;</b>
<b class="fc"><i>583</i>&nbsp;          break;</b>
<i>584</i>&nbsp;        }
<i>585</i>&nbsp;      } else {
<b class="fc"><i>586</i>&nbsp;        switch (state) {</b>
<i>587</i>&nbsp;        case 1:
<b class="fc"><i>588</i>&nbsp;          currentValue = Integer.valueOf(valueBuffer.toString());</b>
<i>589</i>&nbsp;        case 0:
<b class="fc"><i>590</i>&nbsp;          if (currentValue == null) {</b>
<b class="nc"><i>591</i>&nbsp;            throw new DurationParsingException(&quot;Failed to parse value=&quot; + lengthAsString);</b>
<i>592</i>&nbsp;          }
<b class="fc"><i>593</i>&nbsp;          state = 2;</b>
<b class="fc"><i>594</i>&nbsp;          valueBuffer.setLength(0);</b>
<i>595</i>&nbsp;        case 2:
<b class="fc"><i>596</i>&nbsp;          valueBuffer.append(nextChar);</b>
<i>597</i>&nbsp;          break;
<i>598</i>&nbsp;        }
<i>599</i>&nbsp;      }
<i>600</i>&nbsp;    }
<b class="fc"><i>601</i>&nbsp;    if (currentValue != null) {</b>
<b class="nc"><i>602</i>&nbsp;      currentValue = Integer.valueOf(valueBuffer.toString());</b>
<b class="nc"><i>603</i>&nbsp;      TimeUnit dayUnit = findTimeUnit(&quot;d&quot;);</b>
<b class="nc"><i>604</i>&nbsp;      currentLength = createLength(dayUnit, currentValue.floatValue());</b>
<i>605</i>&nbsp;    }
<b class="fc"><i>606</i>&nbsp;    return currentLength;</b>
<i>607</i>&nbsp;  }
<i>608</i>&nbsp;
<i>609</i>&nbsp;  private TimeUnit findTimeUnit(String code) {
<b class="fc"><i>610</i>&nbsp;    return myConfig.getTimeUnitStack().findTimeUnit(code);</b>
<i>611</i>&nbsp;  }
<i>612</i>&nbsp;
<i>613</i>&nbsp;  @Override
<i>614</i>&nbsp;  public TimeDuration createLength(TimeUnit unit, float length) {
<b class="fc"><i>615</i>&nbsp;    return new TimeDurationImpl(unit, length);</b>
<i>616</i>&nbsp;  }
<i>617</i>&nbsp;
<i>618</i>&nbsp;  @Override
<i>619</i>&nbsp;  public TimeDuration createLength(long count) {
<b class="fc"><i>620</i>&nbsp;    return new TimeDurationImpl(getConfig().getTimeUnitStack().getDefaultTimeUnit(), count);</b>
<i>621</i>&nbsp;  }
<i>622</i>&nbsp;
<i>623</i>&nbsp;  @Override
<i>624</i>&nbsp;  public TimeDuration createLength(TimeUnit timeUnit, Date startDate, Date endDate) {
<b class="fc"><i>625</i>&nbsp;    return getConfig().getTimeUnitStack().createDuration(timeUnit, startDate, endDate);</b>
<i>626</i>&nbsp;  }
<i>627</i>&nbsp;
<i>628</i>&nbsp;  @Override
<i>629</i>&nbsp;  public Date shift(Date original, TimeDuration duration) {
<b class="nc"><i>630</i>&nbsp;    GPCalendarCalc calendar = RESTLESS_CALENDAR;</b>
<b class="nc"><i>631</i>&nbsp;    return calendar.shiftDate(original, duration);</b>
<i>632</i>&nbsp;  }
<i>633</i>&nbsp;
<i>634</i>&nbsp;  @Override
<i>635</i>&nbsp;  public TaskDependencyCollection getDependencyCollection() {
<b class="fc"><i>636</i>&nbsp;    return myDependencyCollection;</b>
<i>637</i>&nbsp;  }
<i>638</i>&nbsp;
<i>639</i>&nbsp;  @Override
<i>640</i>&nbsp;  public AlgorithmCollection getAlgorithmCollection() {
<b class="fc"><i>641</i>&nbsp;    return myAlgorithmCollection;</b>
<i>642</i>&nbsp;  }
<i>643</i>&nbsp;
<i>644</i>&nbsp;  public TaskHierarchyManagerImpl getHierarchyManager() {
<b class="fc"><i>645</i>&nbsp;    return myHierarchyManager;</b>
<i>646</i>&nbsp;  }
<i>647</i>&nbsp;
<i>648</i>&nbsp;  @Override
<i>649</i>&nbsp;  public TaskDependencyConstraint createConstraint(final TaskDependencyConstraint.Type type) {
<i>650</i>&nbsp;    TaskDependencyConstraint result;
<b class="fc"><i>651</i>&nbsp;    switch (type) {</b>
<i>652</i>&nbsp;    case finishstart:
<b class="fc"><i>653</i>&nbsp;      result = new FinishStartConstraintImpl();</b>
<b class="fc"><i>654</i>&nbsp;      break;</b>
<i>655</i>&nbsp;    case finishfinish:
<b class="fc"><i>656</i>&nbsp;      result = new FinishFinishConstraintImpl();</b>
<b class="fc"><i>657</i>&nbsp;      break;</b>
<i>658</i>&nbsp;    case startfinish:
<b class="fc"><i>659</i>&nbsp;      result = new StartFinishConstraintImpl();</b>
<b class="fc"><i>660</i>&nbsp;      break;</b>
<i>661</i>&nbsp;    case startstart:
<b class="fc"><i>662</i>&nbsp;      result = new StartStartConstraintImpl();</b>
<b class="fc"><i>663</i>&nbsp;      break;</b>
<i>664</i>&nbsp;    default:
<b class="nc"><i>665</i>&nbsp;      throw new IllegalArgumentException(&quot;Unknown constraint type=&quot; + type);</b>
<i>666</i>&nbsp;    }
<b class="fc"><i>667</i>&nbsp;    return result;</b>
<i>668</i>&nbsp;  }
<i>669</i>&nbsp;
<i>670</i>&nbsp;  @Override
<i>671</i>&nbsp;  public void addTaskListener(TaskListener listener) {
<b class="fc"><i>672</i>&nbsp;    myListeners.add(listener);</b>
<b class="fc"><i>673</i>&nbsp;  }</b>
<i>674</i>&nbsp;
<i>675</i>&nbsp;  @Override
<i>676</i>&nbsp;  public GPCalendarCalc getCalendar() {
<b class="fc"><i>677</i>&nbsp;    return getConfig().getCalendar();</b>
<i>678</i>&nbsp;  }
<i>679</i>&nbsp;
<i>680</i>&nbsp;  public ProjectEventListener getProjectListener() {
<b class="fc"><i>681</i>&nbsp;    return new ProjectEventListener.Stub() {</b>
<i>682</i>&nbsp;      @Override
<i>683</i>&nbsp;      public void projectClosed() {
<b class="fc"><i>684</i>&nbsp;        TaskManagerImpl.this.projectClosed();</b>
<b class="fc"><i>685</i>&nbsp;      }</b>
<i>686</i>&nbsp;
<i>687</i>&nbsp;      @Override
<i>688</i>&nbsp;      public void projectOpened() {
<b class="nc"><i>689</i>&nbsp;        TaskManagerImpl.this.projectOpened();</b>
<b class="nc"><i>690</i>&nbsp;      }</b>
<i>691</i>&nbsp;    };
<i>692</i>&nbsp;  }
<i>693</i>&nbsp;
<i>694</i>&nbsp;  public GPCalendarListener getCalendarListener() {
<b class="fc"><i>695</i>&nbsp;    return new GPCalendarListener() {</b>
<i>696</i>&nbsp;      @Override
<i>697</i>&nbsp;      public void onCalendarChange() {
<b class="fc"><i>698</i>&nbsp;        for (Task t : getTasks()) {</b>
<b class="nc"><i>699</i>&nbsp;          t.setEnd(null);</b>
<i>700</i>&nbsp;        }
<b class="fc"><i>701</i>&nbsp;        myScheduler.run();</b>
<b class="fc"><i>702</i>&nbsp;      }</b>
<i>703</i>&nbsp;    };
<i>704</i>&nbsp;  }
<i>705</i>&nbsp;  public void fireTaskProgressChanged(Task changedTask) {
<b class="fc"><i>706</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>707</i>&nbsp;      TaskPropertyEvent e = new TaskPropertyEvent(changedTask);</b>
<b class="fc"><i>708</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>709</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>710</i>&nbsp;        next.taskProgressChanged(e);</b>
<i>711</i>&nbsp;      }
<i>712</i>&nbsp;    }
<b class="fc"><i>713</i>&nbsp;  }</b>
<i>714</i>&nbsp;
<i>715</i>&nbsp;  void fireTaskScheduleChanged(Task changedTask, GanttCalendar oldStartDate, GanttCalendar oldFinishDate) {
<b class="fc"><i>716</i>&nbsp;    myScheduler.run();</b>
<b class="fc"><i>717</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>718</i>&nbsp;      TaskScheduleEvent e = new TaskScheduleEvent(changedTask, oldStartDate, oldFinishDate, changedTask.getStart(),</b>
<b class="fc"><i>719</i>&nbsp;          changedTask.getEnd());</b>
<i>720</i>&nbsp;      // List copy = new ArrayList(myListeners);
<i>721</i>&nbsp;      // myListeners.clear();
<b class="fc"><i>722</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>723</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>724</i>&nbsp;        next.taskScheduleChanged(e);</b>
<i>725</i>&nbsp;      }
<i>726</i>&nbsp;    }
<b class="fc"><i>727</i>&nbsp;  }</b>
<i>728</i>&nbsp;
<i>729</i>&nbsp;  private void fireDependencyAdded(TaskDependency newDependency) {
<b class="fc"><i>730</i>&nbsp;    myDependencyGraph.addDependency(newDependency);</b>
<b class="fc"><i>731</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>732</i>&nbsp;      TaskDependencyEvent e = new TaskDependencyEvent(getDependencyCollection(), newDependency);</b>
<b class="fc"><i>733</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>734</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>735</i>&nbsp;        next.dependencyAdded(e);</b>
<i>736</i>&nbsp;      }
<i>737</i>&nbsp;    }
<b class="fc"><i>738</i>&nbsp;  }</b>
<i>739</i>&nbsp;
<i>740</i>&nbsp;  private void fireDependencyRemoved(TaskDependency dep) {
<b class="fc"><i>741</i>&nbsp;    myDependencyGraph.removeDependency(dep);</b>
<b class="fc"><i>742</i>&nbsp;    TaskDependencyEvent e = new TaskDependencyEvent(getDependencyCollection(), dep);</b>
<b class="fc"><i>743</i>&nbsp;    for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>744</i>&nbsp;      TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>745</i>&nbsp;      next.dependencyRemoved(e);</b>
<i>746</i>&nbsp;    }
<b class="fc"><i>747</i>&nbsp;  }</b>
<i>748</i>&nbsp;
<i>749</i>&nbsp;  private void fireDependencyChanged(TaskDependency dep) {
<b class="fc"><i>750</i>&nbsp;    TaskDependencyEvent e = new TaskDependencyEvent(getDependencyCollection(), dep);</b>
<b class="fc"><i>751</i>&nbsp;    for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>752</i>&nbsp;      TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>753</i>&nbsp;      next.dependencyChanged(e);</b>
<i>754</i>&nbsp;    }
<b class="fc"><i>755</i>&nbsp;  }</b>
<i>756</i>&nbsp;
<i>757</i>&nbsp;  private void fireTaskAdded(Task task) {
<b class="fc"><i>758</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>759</i>&nbsp;      TaskHierarchyEvent e = new TaskHierarchyEvent(this, task, null, getTaskHierarchy().getContainer(task));</b>
<b class="fc"><i>760</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>761</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>762</i>&nbsp;        next.taskAdded(e);</b>
<i>763</i>&nbsp;      }
<i>764</i>&nbsp;    }
<b class="fc"><i>765</i>&nbsp;  }</b>
<i>766</i>&nbsp;
<i>767</i>&nbsp;  private void fireTaskRemoved(Task container, Task task) {
<b class="fc"><i>768</i>&nbsp;    myDependencyGraph.removeTask(task);</b>
<b class="fc"><i>769</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>770</i>&nbsp;      TaskHierarchyEvent e = new TaskHierarchyEvent(this, task, container, null);</b>
<b class="fc"><i>771</i>&nbsp;      for (TaskListener l : myListeners) {</b>
<b class="fc"><i>772</i>&nbsp;        l.taskRemoved(e);</b>
<b class="fc"><i>773</i>&nbsp;      }</b>
<i>774</i>&nbsp;    }
<b class="fc"><i>775</i>&nbsp;  }</b>
<i>776</i>&nbsp;  void fireTaskPropertiesChanged(Task task) {
<b class="fc"><i>777</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>778</i>&nbsp;      TaskPropertyEvent e = new TaskPropertyEvent(task);</b>
<b class="fc"><i>779</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>780</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>781</i>&nbsp;        next.taskPropertiesChanged(e);</b>
<i>782</i>&nbsp;      }
<i>783</i>&nbsp;    }
<b class="fc"><i>784</i>&nbsp;  }</b>
<i>785</i>&nbsp;
<i>786</i>&nbsp;  private void fireTaskModelReset() {
<b class="fc"><i>787</i>&nbsp;    if (areEventsEnabled) {</b>
<b class="fc"><i>788</i>&nbsp;      for (int i = 0; i &lt; myListeners.size(); i++) {</b>
<b class="fc"><i>789</i>&nbsp;        TaskListener next = myListeners.get(i);</b>
<b class="fc"><i>790</i>&nbsp;        next.taskModelReset();</b>
<i>791</i>&nbsp;      }
<i>792</i>&nbsp;    }
<b class="fc"><i>793</i>&nbsp;  }</b>
<i>794</i>&nbsp;
<i>795</i>&nbsp;  public TaskManagerConfig getConfig() {
<b class="fc"><i>796</i>&nbsp;    return myConfig;</b>
<i>797</i>&nbsp;  }
<i>798</i>&nbsp;
<b class="fc"><i>799</i>&nbsp;  private final class FacadeImpl implements TaskContainmentHierarchyFacade {</b>
<i>800</i>&nbsp;    // private final Task myRoot;
<i>801</i>&nbsp;
<b class="fc"><i>802</i>&nbsp;    private List&lt;Task&gt; myPathBuffer = new ArrayList&lt;Task&gt;();</b>
<i>803</i>&nbsp;
<i>804</i>&nbsp;    // public FacadeImpl(Task root) {
<i>805</i>&nbsp;    // myRoot = root;
<i>806</i>&nbsp;    // }
<i>807</i>&nbsp;
<i>808</i>&nbsp;    @Override
<i>809</i>&nbsp;    public Task[] getNestedTasks(Task container) {
<b class="fc"><i>810</i>&nbsp;      return container.getNestedTasks();</b>
<i>811</i>&nbsp;    }
<i>812</i>&nbsp;
<i>813</i>&nbsp;    @Override
<i>814</i>&nbsp;    public Task[] getDeepNestedTasks(Task container) {
<b class="fc"><i>815</i>&nbsp;      ArrayList&lt;Task&gt; result = new ArrayList&lt;Task&gt;();</b>
<b class="fc"><i>816</i>&nbsp;      addDeepNestedTasks(container, result);</b>
<b class="fc"><i>817</i>&nbsp;      return result.toArray(new Task[result.size()]);</b>
<i>818</i>&nbsp;    }
<i>819</i>&nbsp;
<i>820</i>&nbsp;    private void addDeepNestedTasks(Task container, ArrayList&lt;Task&gt; result) {
<b class="fc"><i>821</i>&nbsp;      Task[] nested = container.getNestedTasks();</b>
<b class="fc"><i>822</i>&nbsp;      result.addAll(Arrays.asList(nested));</b>
<b class="fc"><i>823</i>&nbsp;      for (int i = 0; i &lt; nested.length; i++) {</b>
<b class="fc"><i>824</i>&nbsp;        addDeepNestedTasks(nested[i], result);</b>
<i>825</i>&nbsp;      }
<b class="fc"><i>826</i>&nbsp;    }</b>
<i>827</i>&nbsp;
<i>828</i>&nbsp;    @Override
<i>829</i>&nbsp;    public boolean hasNestedTasks(Task container) {
<b class="fc"><i>830</i>&nbsp;      return container.getNestedTasks().length &gt; 0;</b>
<i>831</i>&nbsp;    }
<i>832</i>&nbsp;
<i>833</i>&nbsp;    @Override
<i>834</i>&nbsp;    public Task getRootTask() {
<b class="fc"><i>835</i>&nbsp;      return TaskManagerImpl.this.getRootTask();</b>
<i>836</i>&nbsp;    }
<i>837</i>&nbsp;
<i>838</i>&nbsp;    @Override
<i>839</i>&nbsp;    public Task getContainer(Task nestedTask) {
<b class="fc"><i>840</i>&nbsp;      return nestedTask.getSupertask();</b>
<i>841</i>&nbsp;    }
<i>842</i>&nbsp;
<i>843</i>&nbsp;    @Override
<i>844</i>&nbsp;    public void sort(Comparator&lt;Task&gt; comparator) {
<b class="nc"><i>845</i>&nbsp;      throw new UnsupportedOperationException(&quot;Sort is not available int this implementation. It is stateless!&quot;);</b>
<i>846</i>&nbsp;    }
<i>847</i>&nbsp;
<i>848</i>&nbsp;    @Override
<i>849</i>&nbsp;    public Task getPreviousSibling(Task nestedTask) {
<b class="fc"><i>850</i>&nbsp;      int pos = getTaskIndex(nestedTask);</b>
<b class="fc"><i>851</i>&nbsp;      return pos == 0 ? null : nestedTask.getSupertask().getNestedTasks()[pos - 1];</b>
<i>852</i>&nbsp;    }
<i>853</i>&nbsp;
<i>854</i>&nbsp;    @Override
<i>855</i>&nbsp;    public Task getNextSibling(Task nestedTask) {
<b class="nc"><i>856</i>&nbsp;      throw new UnsupportedOperationException();</b>
<i>857</i>&nbsp;    }
<i>858</i>&nbsp;
<i>859</i>&nbsp;    @Override
<i>860</i>&nbsp;    public int getTaskIndex(Task nestedTask) {
<b class="fc"><i>861</i>&nbsp;      Task container = nestedTask.getSupertask();</b>
<b class="fc"><i>862</i>&nbsp;      if (container == null) {</b>
<b class="nc"><i>863</i>&nbsp;        return 0;</b>
<i>864</i>&nbsp;      }
<b class="fc"><i>865</i>&nbsp;      return Arrays.asList(container.getNestedTasks()).indexOf(nestedTask);</b>
<i>866</i>&nbsp;    }
<i>867</i>&nbsp;
<i>868</i>&nbsp;    @Override
<i>869</i>&nbsp;    public boolean areUnrelated(Task first, Task second) {
<b class="fc"><i>870</i>&nbsp;      if (first.equals(second)) {</b>
<b class="nc"><i>871</i>&nbsp;        return false;</b>
<i>872</i>&nbsp;      }
<b class="fc"><i>873</i>&nbsp;      myPathBuffer.clear();</b>
<b class="fc"><i>874</i>&nbsp;      for (Task container = getContainer(first); container != null; container = getContainer(container)) {</b>
<b class="fc"><i>875</i>&nbsp;        myPathBuffer.add(container);</b>
<i>876</i>&nbsp;      }
<b class="fc"><i>877</i>&nbsp;      if (myPathBuffer.contains(second)) {</b>
<b class="fc"><i>878</i>&nbsp;        return false;</b>
<i>879</i>&nbsp;      }
<b class="fc"><i>880</i>&nbsp;      myPathBuffer.clear();</b>
<b class="fc"><i>881</i>&nbsp;      for (Task container = getContainer(second); container != null; container = getContainer(container)) {</b>
<b class="fc"><i>882</i>&nbsp;        myPathBuffer.add(container);</b>
<i>883</i>&nbsp;      }
<b class="fc"><i>884</i>&nbsp;      if (myPathBuffer.contains(first)) {</b>
<b class="fc"><i>885</i>&nbsp;        return false;</b>
<i>886</i>&nbsp;      }
<b class="fc"><i>887</i>&nbsp;      return true;</b>
<i>888</i>&nbsp;    }
<i>889</i>&nbsp;
<i>890</i>&nbsp;    @Override
<i>891</i>&nbsp;    public void move(Task whatMove, Task whereMove) {
<b class="fc"><i>892</i>&nbsp;      whatMove.move(whereMove);</b>
<b class="fc"><i>893</i>&nbsp;    }</b>
<i>894</i>&nbsp;
<i>895</i>&nbsp;    @Override
<i>896</i>&nbsp;    public void move(Task whatMove, Task whereMove, int index) {
<b class="fc"><i>897</i>&nbsp;      whatMove.move(whereMove);</b>
<b class="fc"><i>898</i>&nbsp;    }</b>
<i>899</i>&nbsp;
<i>900</i>&nbsp;    @Override
<i>901</i>&nbsp;    public int getDepth(Task task) {
<b class="fc"><i>902</i>&nbsp;      int depth = 0;</b>
<b class="fc"><i>903</i>&nbsp;      while (task != myRoot) {</b>
<b class="fc"><i>904</i>&nbsp;        task = task.getSupertask();</b>
<b class="fc"><i>905</i>&nbsp;        depth++;</b>
<i>906</i>&nbsp;      }
<b class="fc"><i>907</i>&nbsp;      return depth;</b>
<i>908</i>&nbsp;    }
<i>909</i>&nbsp;
<i>910</i>&nbsp;    @Override
<i>911</i>&nbsp;    public int compareDocumentOrder(Task task1, Task task2) {
<b class="fc"><i>912</i>&nbsp;      if (task1 == task2) {</b>
<b class="nc"><i>913</i>&nbsp;        return 0;</b>
<i>914</i>&nbsp;      }
<b class="fc"><i>915</i>&nbsp;      List&lt;Task&gt; buffer1 = new ArrayList&lt;Task&gt;();</b>
<b class="fc"><i>916</i>&nbsp;      for (Task container = task1; container != null; container = getContainer(container)) {</b>
<b class="fc"><i>917</i>&nbsp;        buffer1.add(0, container);</b>
<i>918</i>&nbsp;      }
<b class="fc"><i>919</i>&nbsp;      List&lt;Task&gt; buffer2 = new ArrayList&lt;Task&gt;();</b>
<b class="fc"><i>920</i>&nbsp;      for (Task container = task2; container != null; container = getContainer(container)) {</b>
<b class="fc"><i>921</i>&nbsp;        buffer2.add(0, container);</b>
<i>922</i>&nbsp;      }
<b class="fc"><i>923</i>&nbsp;      if (buffer1.get(0) != getRootTask() &amp;&amp; buffer2.get(0) == getRootTask()) {</b>
<b class="nc"><i>924</i>&nbsp;        return -1;</b>
<i>925</i>&nbsp;      }
<b class="fc"><i>926</i>&nbsp;      if (buffer1.get(0) == getRootTask() &amp;&amp; buffer2.get(0) != getRootTask()) {</b>
<b class="nc"><i>927</i>&nbsp;        return 1;</b>
<i>928</i>&nbsp;      }
<i>929</i>&nbsp;
<b class="fc"><i>930</i>&nbsp;      int i = 0;</b>
<b class="fc"><i>931</i>&nbsp;      Task commonRoot = null;</b>
<i>932</i>&nbsp;      while (true) {
<b class="fc"><i>933</i>&nbsp;        if (i == buffer1.size()) {</b>
<b class="nc"><i>934</i>&nbsp;          return -1;</b>
<i>935</i>&nbsp;        }
<b class="fc"><i>936</i>&nbsp;        if (i == buffer2.size()) {</b>
<b class="fc"><i>937</i>&nbsp;          return 1;</b>
<i>938</i>&nbsp;        }
<b class="fc"><i>939</i>&nbsp;        Task root1 = buffer1.get(i);</b>
<b class="fc"><i>940</i>&nbsp;        Task root2 = buffer2.get(i);</b>
<b class="fc"><i>941</i>&nbsp;        if (root1 != root2) {</b>
<b class="fc"><i>942</i>&nbsp;          assert commonRoot != null : &quot;Failure comparing task=&quot; + task1 + &quot; and task=&quot; + task2 + &quot;\n. Path1=&quot; + buffer1</b>
<i>943</i>&nbsp;              + &quot;\nPath2=&quot; + buffer2;
<b class="fc"><i>944</i>&nbsp;          Task[] nestedTasks = commonRoot.getNestedTasks();</b>
<b class="fc"><i>945</i>&nbsp;          for (int j = 0; j &lt; nestedTasks.length; j++) {</b>
<b class="fc"><i>946</i>&nbsp;            if (nestedTasks[j] == root1) {</b>
<b class="fc"><i>947</i>&nbsp;              return -1;</b>
<i>948</i>&nbsp;            }
<b class="fc"><i>949</i>&nbsp;            if (nestedTasks[j] == root2) {</b>
<b class="fc"><i>950</i>&nbsp;              return 1;</b>
<i>951</i>&nbsp;            }
<i>952</i>&nbsp;          }
<b class="nc"><i>953</i>&nbsp;          throw new IllegalStateException(&quot;We should not be here&quot;);</b>
<i>954</i>&nbsp;        }
<b class="fc"><i>955</i>&nbsp;        i++;</b>
<b class="fc"><i>956</i>&nbsp;        commonRoot = root1;</b>
<b class="fc"><i>957</i>&nbsp;      }</b>
<i>958</i>&nbsp;    }
<i>959</i>&nbsp;
<i>960</i>&nbsp;    @Override
<i>961</i>&nbsp;    public boolean contains(Task task) {
<b class="nc"><i>962</i>&nbsp;      throw new UnsupportedOperationException();</b>
<i>963</i>&nbsp;    }
<i>964</i>&nbsp;
<i>965</i>&nbsp;    @Override
<i>966</i>&nbsp;    public List&lt;Task&gt; getTasksInDocumentOrder() {
<b class="fc"><i>967</i>&nbsp;      List&lt;Task&gt; result = Lists.newArrayList();</b>
<b class="fc"><i>968</i>&nbsp;      LinkedList&lt;Task&gt; deque = new LinkedList&lt;&gt;();</b>
<b class="fc"><i>969</i>&nbsp;      deque.addFirst(getRootTask());</b>
<b class="fc"><i>970</i>&nbsp;      while (!deque.isEmpty()) {</b>
<b class="fc"><i>971</i>&nbsp;        Task head = deque.poll();</b>
<b class="fc"><i>972</i>&nbsp;        result.add(head);</b>
<b class="fc"><i>973</i>&nbsp;        deque.addAll(0, Arrays.asList(head.getNestedTasks()));</b>
<b class="fc"><i>974</i>&nbsp;      }</b>
<b class="fc"><i>975</i>&nbsp;      result.remove(0);</b>
<b class="fc"><i>976</i>&nbsp;      return result;</b>
<i>977</i>&nbsp;    }
<i>978</i>&nbsp;
<i>979</i>&nbsp;
<i>980</i>&nbsp;    @Override
<i>981</i>&nbsp;    public void breadthFirstSearch(Task root, Predicate&lt;Pair&lt;Task, Task&gt;&gt; predicate) {
<b class="fc"><i>982</i>&nbsp;      Preconditions.checkNotNull(root);</b>
<b class="fc"><i>983</i>&nbsp;      Queue&lt;Task&gt; queue = Queues.newArrayDeque();</b>
<b class="fc"><i>984</i>&nbsp;      if (predicate.apply(Pair.create((Task) null, root))) {</b>
<b class="fc"><i>985</i>&nbsp;        queue.add(root);</b>
<i>986</i>&nbsp;      }
<b class="fc"><i>987</i>&nbsp;      while (!queue.isEmpty()) {</b>
<b class="fc"><i>988</i>&nbsp;        Task head = queue.poll();</b>
<b class="fc"><i>989</i>&nbsp;        for (Task child : head.getNestedTasks()) {</b>
<b class="fc"><i>990</i>&nbsp;          if (predicate.apply(Pair.create(head, child))) {</b>
<b class="fc"><i>991</i>&nbsp;            queue.add(child);</b>
<i>992</i>&nbsp;          }
<i>993</i>&nbsp;        }
<b class="fc"><i>994</i>&nbsp;      }</b>
<b class="fc"><i>995</i>&nbsp;    }</b>
<i>996</i>&nbsp;
<i>997</i>&nbsp;    @Override
<i>998</i>&nbsp;    public List&lt;Task&gt; breadthFirstSearch(Task root, final boolean includeRoot) {
<b class="fc"><i>999</i>&nbsp;      final Task _root = (root == null) ? getRootTask() : root;</b>
<b class="fc"><i>1000</i>&nbsp;      final List&lt;Task&gt; result = Lists.newArrayList();</b>
<b class="fc"><i>1001</i>&nbsp;      breadthFirstSearch(_root, new Predicate&lt;Pair&lt;Task,Task&gt;&gt;() {</b>
<i>1002</i>&nbsp;        public boolean apply(Pair&lt;Task, Task&gt; parent_child) {
<b class="fc"><i>1003</i>&nbsp;          if (includeRoot || parent_child.first() != null) {</b>
<b class="fc"><i>1004</i>&nbsp;            result.add(parent_child.second());</b>
<i>1005</i>&nbsp;          }
<b class="fc"><i>1006</i>&nbsp;          return true;</b>
<i>1007</i>&nbsp;        }
<i>1008</i>&nbsp;      });
<b class="fc"><i>1009</i>&nbsp;      return result;</b>
<i>1010</i>&nbsp;    }
<i>1011</i>&nbsp;
<i>1012</i>&nbsp;    @Override
<i>1013</i>&nbsp;    public List&lt;Integer&gt; getOutlinePath(Task task) {
<b class="nc"><i>1014</i>&nbsp;      throw new UnsupportedOperationException();</b>
<i>1015</i>&nbsp;    }
<i>1016</i>&nbsp;  }
<i>1017</i>&nbsp;
<b class="fc"><i>1018</i>&nbsp;  private class FacadeFactoryImpl implements TaskContainmentHierarchyFacade.Factory {</b>
<i>1019</i>&nbsp;    // private final Task myRoot;
<i>1020</i>&nbsp;    //
<i>1021</i>&nbsp;    // FacadeFactoryImpl(Task root) {
<i>1022</i>&nbsp;    // myRoot = root;
<i>1023</i>&nbsp;    // }
<i>1024</i>&nbsp;
<i>1025</i>&nbsp;    @Override
<i>1026</i>&nbsp;    public TaskContainmentHierarchyFacade createFacade() {
<b class="fc"><i>1027</i>&nbsp;      return new FacadeImpl();</b>
<i>1028</i>&nbsp;    }
<i>1029</i>&nbsp;  }
<i>1030</i>&nbsp;
<i>1031</i>&nbsp;  @Override
<i>1032</i>&nbsp;  public TaskContainmentHierarchyFacade getTaskHierarchy() {
<i>1033</i>&nbsp;    // if (myTaskContainment==null) {
<b class="fc"><i>1034</i>&nbsp;    return myFacadeFactory.createFacade();</b>
<i>1035</i>&nbsp;    // }
<i>1036</i>&nbsp;    // return myTaskContainment;
<i>1037</i>&nbsp;  }
<i>1038</i>&nbsp;
<i>1039</i>&nbsp;  @Override
<i>1040</i>&nbsp;  public TaskManager emptyClone() {
<b class="nc"><i>1041</i>&nbsp;    TaskManagerImpl result = new TaskManagerImpl(null, myConfig);</b>
<b class="nc"><i>1042</i>&nbsp;    result.myDependencyHardnessOption.setValue(this.myDependencyHardnessOption.getValue());</b>
<b class="nc"><i>1043</i>&nbsp;    return result;</b>
<i>1044</i>&nbsp;  }
<i>1045</i>&nbsp;
<i>1046</i>&nbsp;  @Override
<i>1047</i>&nbsp;  public Map&lt;Task, Task&gt; importData(TaskManager taskManager,
<i>1048</i>&nbsp;      Map&lt;CustomPropertyDefinition, CustomPropertyDefinition&gt; customPropertyMapping) {
<b class="fc"><i>1049</i>&nbsp;    Task importRoot = taskManager.getRootTask();</b>
<b class="fc"><i>1050</i>&nbsp;    Map&lt;Task, Task&gt; original2imported = new LinkedHashMap&lt;Task, Task&gt;();</b>
<b class="fc"><i>1051</i>&nbsp;    importData(importRoot, getRootTask(), customPropertyMapping, original2imported);</b>
<b class="fc"><i>1052</i>&nbsp;    TaskDependency[] deps = taskManager.getDependencyCollection().getDependencies();</b>
<b class="fc"><i>1053</i>&nbsp;    for (int i = 0; i &lt; deps.length; i++) {</b>
<b class="nc"><i>1054</i>&nbsp;      Task nextDependant = deps[i].getDependant();</b>
<b class="nc"><i>1055</i>&nbsp;      Task nextDependee = deps[i].getDependee();</b>
<b class="nc"><i>1056</i>&nbsp;      Task importedDependant = original2imported.get(nextDependant);</b>
<b class="nc"><i>1057</i>&nbsp;      Task importedDependee = original2imported.get(nextDependee);</b>
<i>1058</i>&nbsp;      try {
<b class="nc"><i>1059</i>&nbsp;        TaskDependency dependency = getDependencyCollection().createDependency(importedDependant, importedDependee,</b>
<i>1060</i>&nbsp;            new FinishStartConstraintImpl());
<b class="nc"><i>1061</i>&nbsp;        dependency.setConstraint(deps[i].getConstraint());</b>
<b class="nc"><i>1062</i>&nbsp;        dependency.setDifference(deps[i].getDifference());</b>
<b class="nc"><i>1063</i>&nbsp;        dependency.setHardness(deps[i].getHardness());</b>
<b class="nc"><i>1064</i>&nbsp;      } catch (TaskDependencyException e) {</b>
<b class="nc"><i>1065</i>&nbsp;        if (!GPLogger.log(e)) {</b>
<b class="nc"><i>1066</i>&nbsp;          e.printStackTrace(System.err);</b>
<i>1067</i>&nbsp;        }
<b class="nc"><i>1068</i>&nbsp;      }</b>
<i>1069</i>&nbsp;    }
<b class="fc"><i>1070</i>&nbsp;    return original2imported;</b>
<i>1071</i>&nbsp;  }
<i>1072</i>&nbsp;
<i>1073</i>&nbsp;  private void importData(Task importRoot, Task root,
<i>1074</i>&nbsp;      Map&lt;CustomPropertyDefinition, CustomPropertyDefinition&gt; customPropertyMapping, Map&lt;Task, Task&gt; original2imported) {
<b class="fc"><i>1075</i>&nbsp;    Task[] nested = importRoot.getManager().getTaskHierarchy().getNestedTasks(importRoot);</b>
<b class="fc"><i>1076</i>&nbsp;    for (int i = 0; i &lt; nested.length; i++) {</b>
<b class="fc"><i>1077</i>&nbsp;      TaskManager.TaskBuilder builder = newTaskBuilder();</b>
<b class="fc"><i>1078</i>&nbsp;      GanttTask that = (GanttTask) nested[i];</b>
<b class="fc"><i>1079</i>&nbsp;      if (getTask(that.getTaskID()) == null) {</b>
<b class="fc"><i>1080</i>&nbsp;        builder = builder.withId(that.getTaskID());</b>
<i>1081</i>&nbsp;      }
<b class="fc"><i>1082</i>&nbsp;      Task nextImported = builder</b>
<b class="fc"><i>1083</i>&nbsp;          .withName(that.getName())</b>
<b class="fc"><i>1084</i>&nbsp;          .withStartDate(that.getStart().getTime())</b>
<b class="fc"><i>1085</i>&nbsp;          .withDuration(that.getDuration())</b>
<b class="fc"><i>1086</i>&nbsp;          .withColor(that.getColor())</b>
<b class="fc"><i>1087</i>&nbsp;          .withNotes(that.getNotes())</b>
<b class="fc"><i>1088</i>&nbsp;          .withWebLink(that.getWebLink())</b>
<b class="fc"><i>1089</i>&nbsp;          .withPriority(that.getPriority())</b>
<b class="fc"><i>1090</i>&nbsp;          .withParent(root).build();</b>
<i>1091</i>&nbsp;
<b class="fc"><i>1092</i>&nbsp;      nextImported.setShape(nested[i].getShape());</b>
<b class="fc"><i>1093</i>&nbsp;      nextImported.setCompletionPercentage(nested[i].getCompletionPercentage());</b>
<b class="fc"><i>1094</i>&nbsp;      nextImported.setTaskInfo(nested[i].getTaskInfo());</b>
<b class="fc"><i>1095</i>&nbsp;      nextImported.setExpand(nested[i].getExpand());</b>
<b class="fc"><i>1096</i>&nbsp;      nextImported.setMilestone(nested[i].isMilestone());</b>
<b class="fc"><i>1097</i>&nbsp;      nextImported.getCost().setValue(that.getCost());</b>
<b class="fc"><i>1098</i>&nbsp;      if (nested[i].getThird() != null) {</b>
<b class="nc"><i>1099</i>&nbsp;        nextImported.setThirdDate(nested[i].getThird().clone());</b>
<b class="nc"><i>1100</i>&nbsp;        nextImported.setThirdDateConstraint(nested[i].getThirdDateConstraint());</b>
<i>1101</i>&nbsp;      }
<i>1102</i>&nbsp;
<b class="fc"><i>1103</i>&nbsp;      CustomColumnsValues customValues = nested[i].getCustomValues();</b>
<b class="fc"><i>1104</i>&nbsp;      for (CustomPropertyDefinition thatDef : importRoot.getManager().getCustomPropertyManager().getDefinitions()) {</b>
<b class="nc"><i>1105</i>&nbsp;        CustomPropertyDefinition thisDef = customPropertyMapping.get(thatDef);</b>
<b class="nc"><i>1106</i>&nbsp;        Object value = customValues.getValue(thatDef);</b>
<b class="nc"><i>1107</i>&nbsp;        if (value != null) {</b>
<i>1108</i>&nbsp;          try {
<b class="nc"><i>1109</i>&nbsp;            nextImported.getCustomValues().setValue(thisDef, value);</b>
<b class="nc"><i>1110</i>&nbsp;          } catch (CustomColumnsException e) {</b>
<b class="nc"><i>1111</i>&nbsp;            if (!GPLogger.log(e)) {</b>
<b class="nc"><i>1112</i>&nbsp;              e.printStackTrace(System.err);</b>
<i>1113</i>&nbsp;            }
<b class="nc"><i>1114</i>&nbsp;          }</b>
<i>1115</i>&nbsp;        }
<b class="nc"><i>1116</i>&nbsp;      }</b>
<b class="fc"><i>1117</i>&nbsp;      original2imported.put(nested[i], nextImported);</b>
<b class="fc"><i>1118</i>&nbsp;      importData(nested[i], nextImported, customPropertyMapping, original2imported);</b>
<i>1119</i>&nbsp;    }
<b class="fc"><i>1120</i>&nbsp;  }</b>
<i>1121</i>&nbsp;
<i>1122</i>&nbsp;  public Date findClosestWorkingTime(Date time) {
<b class="fc"><i>1123</i>&nbsp;    return getCalendar().findClosestWorkingTime(time);</b>
<i>1124</i>&nbsp;  }
<i>1125</i>&nbsp;
<i>1126</i>&nbsp;  @Override
<i>1127</i>&nbsp;  public void processCriticalPath(Task root) {
<i>1128</i>&nbsp;    try {
<b class="fc"><i>1129</i>&nbsp;      myAlgorithmCollection.getRecalculateTaskScheduleAlgorithm().run();</b>
<b class="nc"><i>1130</i>&nbsp;    } catch (TaskDependencyException e) {</b>
<b class="nc"><i>1131</i>&nbsp;      if (!GPLogger.log(e)) {</b>
<b class="nc"><i>1132</i>&nbsp;        e.printStackTrace(System.err);</b>
<i>1133</i>&nbsp;      }
<b class="fc"><i>1134</i>&nbsp;    }</b>
<b class="fc"><i>1135</i>&nbsp;    Task[] tasks = myAlgorithmCollection.getCriticalPathAlgorithm().getCriticalTasks();</b>
<b class="fc"><i>1136</i>&nbsp;    resetCriticalPath();</b>
<b class="fc"><i>1137</i>&nbsp;    for (int i = 0; i &lt; tasks.length; i++) {</b>
<b class="fc"><i>1138</i>&nbsp;      tasks[i].setCritical(true);</b>
<i>1139</i>&nbsp;    }
<b class="fc"><i>1140</i>&nbsp;  }</b>
<i>1141</i>&nbsp;
<i>1142</i>&nbsp;  private void resetCriticalPath() {
<b class="fc"><i>1143</i>&nbsp;    Task[] allTasks = getTasks();</b>
<b class="fc"><i>1144</i>&nbsp;    for (int i = 0; i &lt; allTasks.length; i++) {</b>
<b class="fc"><i>1145</i>&nbsp;      allTasks[i].setCritical(false);</b>
<i>1146</i>&nbsp;    }
<b class="fc"><i>1147</i>&nbsp;  }</b>
<i>1148</i>&nbsp;
<i>1149</i>&nbsp;  @Override
<i>1150</i>&nbsp;  public void importAssignments(TaskManager importedTaskManager, HumanResourceManager hrManager,
<i>1151</i>&nbsp;      Map&lt;Task, Task&gt; original2importedTask, Map&lt;HumanResource, HumanResource&gt; original2importedResource) {
<b class="nc"><i>1152</i>&nbsp;    Task[] tasks = importedTaskManager.getTasks();</b>
<b class="nc"><i>1153</i>&nbsp;    for (int i = 0; i &lt; tasks.length; i++) {</b>
<b class="nc"><i>1154</i>&nbsp;      ResourceAssignment[] assignments = tasks[i].getAssignments();</b>
<b class="nc"><i>1155</i>&nbsp;      for (int j = 0; j &lt; assignments.length; j++) {</b>
<b class="nc"><i>1156</i>&nbsp;        Task task = getTask(original2importedTask.get(tasks[i]).getTaskID());</b>
<b class="nc"><i>1157</i>&nbsp;        ResourceAssignment assignment = task.getAssignmentCollection().addAssignment(</b>
<b class="nc"><i>1158</i>&nbsp;            original2importedResource.get(assignments[j].getResource()));</b>
<b class="nc"><i>1159</i>&nbsp;        assignment.setLoad(assignments[j].getLoad());</b>
<b class="nc"><i>1160</i>&nbsp;        assignment.setCoordinator(assignments[j].isCoordinator());</b>
<i>1161</i>&nbsp;      }
<i>1162</i>&nbsp;    }
<b class="nc"><i>1163</i>&nbsp;  }</b>
<i>1164</i>&nbsp;
<i>1165</i>&nbsp;  void onTaskMoved(TaskImpl task) {
<b class="fc"><i>1166</i>&nbsp;    if (!isRegistered(task)) {</b>
<b class="nc"><i>1167</i>&nbsp;      registerTask(task);</b>
<i>1168</i>&nbsp;    }
<b class="fc"><i>1169</i>&nbsp;    myDependencyGraph.move(task, getTaskHierarchy().getContainer(task));</b>
<b class="fc"><i>1170</i>&nbsp;    myTaskMap.setDirty();</b>
<b class="fc"><i>1171</i>&nbsp;  }</b>
<i>1172</i>&nbsp;
<i>1173</i>&nbsp;  public void setEventsEnabled(boolean enabled) {
<b class="fc"><i>1174</i>&nbsp;    areEventsEnabled = enabled;</b>
<b class="fc"><i>1175</i>&nbsp;  }</b>
<i>1176</i>&nbsp;
<i>1177</i>&nbsp;  boolean areEventsEnabled() {
<b class="fc"><i>1178</i>&nbsp;    return areEventsEnabled;</b>
<i>1179</i>&nbsp;  }
<i>1180</i>&nbsp;
<i>1181</i>&nbsp;  @Override
<i>1182</i>&nbsp;  public CustomPropertyManager getCustomPropertyManager() {
<b class="fc"><i>1183</i>&nbsp;    return myCustomColumnsManager;</b>
<i>1184</i>&nbsp;  }
<i>1185</i>&nbsp;
<i>1186</i>&nbsp;  public URL getProjectDocument() {
<b class="nc"><i>1187</i>&nbsp;    return myConfig.getProjectDocumentURL();</b>
<i>1188</i>&nbsp;  }
<i>1189</i>&nbsp;
<i>1190</i>&nbsp;  private static class TaskNamePrefixOption extends DefaultStringOption implements GP1XOptionConverter {
<i>1191</i>&nbsp;    public TaskNamePrefixOption() {
<b class="fc"><i>1192</i>&nbsp;      super(&quot;taskNamePrefix&quot;);</b>
<b class="fc"><i>1193</i>&nbsp;      resetValue(GanttLanguage.getInstance().getText(&quot;defaultTaskPrefix&quot;), true);</b>
<b class="fc"><i>1194</i>&nbsp;    }</b>
<i>1195</i>&nbsp;
<i>1196</i>&nbsp;    @Override
<i>1197</i>&nbsp;    public String getTagName() {
<b class="fc"><i>1198</i>&nbsp;      return &quot;task-name&quot;;</b>
<i>1199</i>&nbsp;    }
<i>1200</i>&nbsp;
<i>1201</i>&nbsp;    @Override
<i>1202</i>&nbsp;    public String getAttributeName() {
<b class="fc"><i>1203</i>&nbsp;      return &quot;prefix&quot;;</b>
<i>1204</i>&nbsp;    }
<i>1205</i>&nbsp;
<i>1206</i>&nbsp;    @Override
<i>1207</i>&nbsp;    public void loadValue(String legacyValue) {
<b class="nc"><i>1208</i>&nbsp;      resetValue(legacyValue, true);</b>
<b class="nc"><i>1209</i>&nbsp;    }</b>
<i>1210</i>&nbsp;  }
<i>1211</i>&nbsp;
<i>1212</i>&nbsp;  @Override
<i>1213</i>&nbsp;  public StringOption getTaskNamePrefixOption() {
<b class="fc"><i>1214</i>&nbsp;    return myTaskNamePrefixOption;</b>
<i>1215</i>&nbsp;  }
<i>1216</i>&nbsp;
<i>1217</i>&nbsp;  @Override
<i>1218</i>&nbsp;  public StringOption getTaskCopyNamePrefixOption() {
<b class="fc"><i>1219</i>&nbsp;    return myTaskCopyNamePrefixOption;</b>
<i>1220</i>&nbsp;  }
<i>1221</i>&nbsp;
<i>1222</i>&nbsp;  @Override
<i>1223</i>&nbsp;  public ColorOption getTaskDefaultColorOption() {
<b class="fc"><i>1224</i>&nbsp;    return myConfig.getDefaultColorOption();</b>
<i>1225</i>&nbsp;  }
<i>1226</i>&nbsp;
<i>1227</i>&nbsp;  @Override
<i>1228</i>&nbsp;  public EnumerationOption getDependencyHardnessOption() {
<b class="fc"><i>1229</i>&nbsp;    return myDependencyHardnessOption;</b>
<i>1230</i>&nbsp;  }
<i>1231</i>&nbsp;
<i>1232</i>&nbsp;  @Override
<i>1233</i>&nbsp;  public void setZeroMilestones(Boolean b) {
<b class="nc"><i>1234</i>&nbsp;    isZeroMilestones = b;</b>
<b class="nc"><i>1235</i>&nbsp;    if (Boolean.TRUE == isZeroMilestones) {</b>
<b class="nc"><i>1236</i>&nbsp;      List&lt;Task&gt; milestones = Lists.newArrayList();</b>
<b class="nc"><i>1237</i>&nbsp;      for (Task t : getTasks()) {</b>
<b class="nc"><i>1238</i>&nbsp;        if (t.isMilestone()) {</b>
<b class="nc"><i>1239</i>&nbsp;          t.setMilestone(true);</b>
<b class="nc"><i>1240</i>&nbsp;          milestones.add(t);</b>
<i>1241</i>&nbsp;        }
<i>1242</i>&nbsp;      }
<b class="nc"><i>1243</i>&nbsp;      getAlgorithmCollection().getAdjustTaskBoundsAlgorithm().run(milestones);</b>
<i>1244</i>&nbsp;      try {
<b class="nc"><i>1245</i>&nbsp;        getAlgorithmCollection().getRecalculateTaskScheduleAlgorithm().run(milestones);</b>
<b class="nc"><i>1246</i>&nbsp;      } catch (TaskDependencyException e) {</b>
<b class="nc"><i>1247</i>&nbsp;        GPLogger.log(e);</b>
<b class="nc"><i>1248</i>&nbsp;      }</b>
<i>1249</i>&nbsp;    }
<b class="nc"><i>1250</i>&nbsp;  }</b>
<i>1251</i>&nbsp;
<i>1252</i>&nbsp;  @Override
<i>1253</i>&nbsp;  public Boolean isZeroMilestones() {
<b class="fc"><i>1254</i>&nbsp;    return isZeroMilestones;</b>
<i>1255</i>&nbsp;  }
<i>1256</i>&nbsp;
<i>1257</i>&nbsp;  @Override
<i>1258</i>&nbsp;  public DependencyGraph getDependencyGraph() {
<b class="fc"><i>1259</i>&nbsp;    return myDependencyGraph;</b>
<i>1260</i>&nbsp;  }
<i>1261</i>&nbsp;}
</div>
</div>

<div class="footer">
    
    <div style="float:right;">generated on 2020-06-01 19:39</div>
</div>
</body>
</html>
